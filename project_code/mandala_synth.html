<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- midi.js package -->
 <script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Player.js" type="text/javascript"></script>
 <script src="./js/MusicTheory/Synesthesia.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.script.js" type="text/javascript"></script>
 <!-- extras -->
 <script src="./inc/Base64.js" type="text/javascript"></script>
 <script src="./inc/base64binary.js" type="text/javascript"></script>
</head>
<body>
  <canvas id="mandala" width="500" height="500"></canvas>
  <canvas id="aspiral" width="500" height="500"></canvas>
  <img src="./mandalas/1/500x500/09b.png" alt=""  id="mandala_img"/>
<script type="text/javascript">

window.onload = function () {

  window.i = 0;

  var mandalaImg = document.getElementById("mandala_img"); 

  var mandala = document.getElementById('mandala');
  var contextMandala = mandala.getContext('2d');
  
  var aspiral = document.getElementById('aspiral');
  var context = aspiral.getContext("2d");
  var centerx = context.canvas.width / 2;
  var centery = context.canvas.height / 2;
  var delay = 0; // play one note every quarter second
  var note = 50; // the MIDI note
  var velocity = 127; // how hard the note hits

  contextMandala.drawImage(mandalaImg, 0, 0);
  mandalaImg.parentNode.removeChild(mandalaImg);

  context.clearRect(0, 0, 500, 500);

  programChange = {
    "acoustic_grand_piano": 1,
    "acoustic_guitar_nylon": 24,
    "baritone_sax": 67,
    "brass_section": 61,
    "distortion_guitar": 30,
    "electric_bass_finger": 34,
    "electric_guitar_jazz":  27,
    "flute": 73,
    "synth_drum": 118
    
  }
  instruments = []
  for (var v in programChange) {
    if (programChange.hasOwnProperty(v))
      instruments.push(v);
  }
  instrumentName = "acoustic_grand_piano"; // instruments[2] ;
  
  MIDI.loadPlugin({ soundfontUrl: "./soundfont/", instruments: instruments,
		callback: function() {
			MIDI.setVolume(0, 127);
      if ((number=programChange[instrumentName]) !=undefined)
	      MIDI.programChange(0, number);


      var count = 0;
        instrument = MIDI.Soundfont[instrumentName];
      for (var k in instrument) {
        if (instrument.hasOwnProperty(k)) {
           ++count;
        }
      }
      var _a = 1;
      var _b = 1;
      note = 60;
      setInterval(function(){
        i+= 1;
        angle = 0.2 * i;
        x = centerx + (_a + _b * angle) * Math.cos(angle);
        y = centery + (_a + _b * angle) * Math.sin(angle);

        context.lineTo(x, y);

        data = contextMandala.getImageData(x, y, x+1, y+1).data;
        r = parseInt(data[0]);
        g = parseInt(data[1]);
        b = parseInt(data[2]);

        context.strokeStyle = "rgba("+r+","+g+","+b+",1)";
        context.stroke();

        //note = parseInt(255-parseInt(data[0])+255-parseInt(data[1])+255-parseInt(data[2]));
        //note = parseInt(parseInt(data[0])+parseInt(data[1])+parseInt(data[2]));
        //note = (r+g+b) % count;
        console.log(note);
        MIDI.noteOn(0, note, velocity, delay);
        note += (note/note-1);

        context.beginPath();
        context.moveTo(x, y);

      },500);
    }
	});


};

</script>
</body>
</html>
